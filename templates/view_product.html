<!-- templates/view_product.html -->
{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>{{ product.name }}</h1>
    <div>
        <a href="{{ url_for('edit_product', id=product.id) }}" class="btn btn-warning">Edit Product</a>
        <form action="{{ url_for('delete_product', id=product.id) }}" method="POST" class="d-inline">
            <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure?')">Delete</button>
        </form>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h3 class="card-title">Product Details</h3>
                <p><strong>Market Demand:</strong> {{ "%.1f"|format(product.market_demand) }}</p>
                <p><strong>Total Cost:</strong> ${{ "%.2f"|format(product.total_cost) }}</p>
                <p><strong>Optimal Price:</strong> ${{ "%.2f"|format(optimal_price) }}</p>
                <p><strong>Description:</strong> {{ product.description or 'No description available' }}</p>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h3 class="card-title">Ingredients</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Ingredient</th>
                            <th>Quantity</th>
                            <th>Cost</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for pi in product.ingredients %}
                        <tr>
                            <td>{{ pi.ingredient.name }}</td>
                            <td>{{ "%.2f"|format(pi.quantity) }} {{ pi.ingredient.unit }}</td>
                            <td>${{ "%.2f"|format(pi.quantity * pi.ingredient.cost_per_unit) }}</td>
                        </tr>
                        {% endfor %}
                        <tr class="table-info">
                            <td colspan="2"><strong>Total Ingredient Cost:</strong></td>
                            <td><strong>${{ "%.2f"|format(product.ingredient_cost) }}</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-body">
                <h3 class="card-title">Competitor Prices</h3>
                <canvas id="priceChart"></canvas>

                <form action="{{ url_for('add_competitor_price', id=product.id) }}" method="POST" class="mt-3">
                    <div class="input-group">
                        <input type="number" step="0.01" name="price" class="form-control"
                               placeholder="Add new competitor price" required>
                        <button type="submit" class="btn btn-primary">Add Price</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('priceChart').getContext('2d');
const priceData = {
    labels: {{ dates|tojson }},
    datasets: [{
        label: 'Competitor Prices',
        data: {{ prices|tojson }},
        borderColor: 'rgb(75, 192, 192)',
        tension: 0.1
    }]
};

new Chart(ctx, {
    type: 'line',
    data: priceData,
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: false
            }
        }
    }
});
</script>
{% endblock %}