{% extends "base.html" %}

{% block content %}
<div class="mb-4">
    <h1>Cost Analysis & Pricing Calculator</h1>
    <p class="text-muted">Calculate comprehensive costs and recommended pricing for your products</p>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Calculate Product Cost</h5>
            </div>
            <div class="card-body">
                <form id="costCalculatorForm">
                    <div class="mb-3">
                        <label for="product_select" class="form-label">Select Product</label>
                        <select class="form-control" id="product_select" name="product_id" required>
                            <option value="">Choose a product...</option>
                            {% for product in products %}
                            <option value="{{ product.id }}" data-batch-size="{{ product.batch_size }}">
                                {{ product.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="batch_size" class="form-label">Batch Size</label>
                        <input type="number" step="0.01" class="form-control" id="batch_size" name="batch_size" placeholder="Enter batch size">
                        <small class="form-text text-muted">Leave empty for default batch size</small>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-calculator me-2"></i>Calculate Cost
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div id="costResults" class="d-none">
            <div class="card">
                <div class="card-header">
                    <h5>Cost Analysis Results</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <canvas id="costBreakdownChart" width="300" height="200"></canvas>
                        </div>
                        <div class="col-md-6">
                            <div id="costDetails"></div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6>Material Breakdown:</h6>
                        <div id="materialBreakdown"></div>
                    </div>
                    
                    <div class="mt-4">
                        <h6>Stock Availability:</h6>
                        <div id="stockStatus"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="loadingSpinner" class="d-none text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Calculating costs...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('costCalculatorForm');
    const productSelect = document.getElementById('product_select');
    const batchSizeInput = document.getElementById('batch_size');
    const costResults = document.getElementById('costResults');
    const loadingSpinner = document.getElementById('loadingSpinner');
    
    let costChart = null;
    
    // Update batch size when product is selected
    productSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            const defaultBatchSize = selectedOption.getAttribute('data-batch-size');
            batchSizeInput.value = defaultBatchSize;
        }
    });
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(form);
        const data = {
            product_id: parseInt(formData.get('product_id')),
            batch_size: formData.get('batch_size') ? parseFloat(formData.get('batch_size')) : null
        };
        
        // Show loading spinner
        loadingSpinner.classList.remove('d-none');
        costResults.classList.add('d-none');
        
        fetch('/api/calculate-cost', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            loadingSpinner.classList.add('d-none');
            
            if (data.success) {
                displayCostResults(data.cost_data, data.stock_data);
                costResults.classList.remove('d-none');
            } else {
                alert('Error calculating cost: ' + data.error);
            }
        })
        .catch(error => {
            loadingSpinner.classList.add('d-none');
            alert('Error calculating cost: ' + error.message);
        });
    });
    
    function displayCostResults(costData, stockData) {
        // Display cost details
        const costDetails = document.getElementById('costDetails');
        costDetails.innerHTML = `
            <div class="row">
                <div class="col-12">
                    <h6 class="text-success">Recommended Price: KSh ${costData.recommended_price.toFixed(2)}</h6>
                    <hr>
                    <p><strong>Material Cost:</strong> KSh ${costData.material_cost.toFixed(2)}</p>
                    <p><strong>Labor Cost:</strong> KSh ${costData.labor_cost.toFixed(2)}</p>
                    <p><strong>Overhead Cost:</strong> KSh ${costData.overhead_cost.toFixed(2)}</p>
                    <p><strong>Packaging Cost:</strong> KSh ${costData.packaging_cost.toFixed(2)}</p>
                    <hr>
                    <p><strong>Total Cost:</strong> KSh ${costData.total_cost.toFixed(2)}</p>
                    <p><strong>Cost per Unit:</strong> KSh ${costData.cost_per_unit.toFixed(2)}</p>
                    <p><strong>Price per Unit:</strong> KSh ${costData.price_per_unit.toFixed(2)}</p>
                </div>
            </div>
        `;
        
        // Display material breakdown
        const materialBreakdown = document.getElementById('materialBreakdown');
        let materialHtml = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Material</th><th>Quantity</th><th>Unit Price</th><th>Total</th></tr></thead><tbody>';
        
        costData.material_details.forEach(material => {
            materialHtml += `
                <tr>
                    <td>${material.material}</td>
                    <td>${material.quantity.toFixed(2)} ${material.unit}</td>
                    <td>KSh ${material.unit_price.toFixed(2)}</td>
                    <td>KSh ${material.total_cost.toFixed(2)}</td>
                </tr>
            `;
        });
        
        materialHtml += '</tbody></table></div>';
        materialBreakdown.innerHTML = materialHtml;
        
        // Display stock status
        const stockStatus = document.getElementById('stockStatus');
        if (stockData.can_produce) {
            stockStatus.innerHTML = '<div class="alert alert-success"><i class="fas fa-check-circle me-2"></i>All materials are available for production</div>';
        } else {
            let statusHtml = '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Insufficient materials for production</div>';
            statusHtml += '<h6>Missing Materials:</h6><ul>';
            
            stockData.missing_materials.forEach(material => {
                statusHtml += `<li>${material.material}: Need ${material.required.toFixed(2)}, Available ${material.available.toFixed(2)} (Shortage: ${material.shortage.toFixed(2)})</li>`;
            });
            
            statusHtml += '</ul>';
            stockStatus.innerHTML = statusHtml;
        }
        
        if (stockData.low_stock_materials.length > 0) {
            let lowStockHtml = '<div class="alert alert-warning mt-2"><i class="fas fa-exclamation-triangle me-2"></i>Low stock warnings:</div><ul>';
            stockData.low_stock_materials.forEach(material => {
                lowStockHtml += `<li>${material.material}: Current ${material.current_stock}, Minimum ${material.minimum_stock}</li>`;
            });
            lowStockHtml += '</ul>';
            stockStatus.innerHTML += lowStockHtml;
        }
        
        // Create cost breakdown chart
        const ctx = document.getElementById('costBreakdownChart').getContext('2d');
        
        if (costChart) {
            costChart.destroy();
        }
        
        costChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Material Cost', 'Labor Cost', 'Overhead Cost', 'Packaging Cost'],
                datasets: [{
                    data: [
                        costData.material_cost,
                        costData.labor_cost,
                        costData.overhead_cost,
                        costData.packaging_cost
                    ],
                    backgroundColor: [
                        '#FF6384',
                        '#36A2EB',
                        '#FFCE56',
                        '#4BC0C0'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'Cost Breakdown'
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}